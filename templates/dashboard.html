<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Guard Pro - Face Mask Detection</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .print\\:hidden { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    {% raw %}
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Inline SVG Icons
        const ShieldCheck = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/></svg>;
        const ShieldAlert = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;
        const Activity = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>;
        const Users = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const Clock = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const Bell = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>;
        const Search = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const FileText = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        const TrendingUp = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const Camera = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>;
        const X = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Printer = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>;

        const App = () => {
          const [stats, setStats] = useState({
            withMask: 0,
            withoutMask: 0,
            total: 0,
            compliance: 0,
          });
          const [currentTime, setCurrentTime] = useState(new Date());
          const [isReportOpen, setIsReportOpen] = useState(false);
          const [hourlyData, setHourlyData] = useState([]);
          const videoRef = useRef(null);

          // Fetch stats from Flask API
          useEffect(() => {
            const fetchStats = async () => {
              try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                if (data.totals) {
                  setStats({
                    withMask: data.totals.with_mask || 0,
                    withoutMask: data.totals.without_mask || 0,
                    total: data.totals.total || 0,
                    compliance: data.totals.compliance || 0,
                  });
                  
                  if (data.hourly) {
                    setHourlyData(data.hourly);
                  }
                }
              } catch (error) {
                console.error('Error fetching stats:', error);
              }
            };

            fetchStats();
            const interval = setInterval(fetchStats, 3000);
            return () => clearInterval(interval);
          }, []);

          // Update clock
          useEffect(() => {
            const timer = setInterval(() => setCurrentTime(new Date()), 1000);
            return () => clearInterval(timer);
          }, []);

          // Camera removed - using OpenCV window for detection
          // Dashboard shows stats only

          const handlePrint = () => window.print();
          
          const handleDownloadPDF = async () => {
            try {
              const response = await fetch('/api/export_pdf');
              if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mask_compliance_report_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
              } else {
                alert('Failed to generate PDF report');
              }
            } catch (error) {
              console.error('PDF download error:', error);
              alert('Error downloading PDF report');
            }
          };

          const StatCard = ({ icon: Icon, label, value, subtext, status }) => (
            <div className="p-6 bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-all">
              <div className="flex justify-between items-start mb-4">
                <div className={`p-2 rounded-lg ${status === 'error' ? 'bg-red-50 text-red-600' : 'bg-slate-50 text-slate-600'}`}>
                  <Icon />
                </div>
              </div>
              <div>
                <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">{label}</p>
                <div className="flex items-baseline gap-2">
                  <h3 className="text-3xl font-bold text-slate-900">{value}</h3>
                  <span className="text-[10px] font-bold text-slate-400">{subtext}</span>
                </div>
              </div>
            </div>
          );

          return (
            <div className="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-slate-900 selection:text-white">
              
              <nav className="h-16 border-b border-slate-200 bg-white flex items-center justify-between px-8 sticky top-0 z-50 print:hidden">
                <div className="flex items-center gap-10">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-slate-900 flex items-center justify-center rounded-lg shadow-lg">
                      <ShieldCheck />
                    </div>
                    <div>
                      <span className="text-sm font-bold tracking-tight block">SECURE_GUARD <span className="text-slate-400 font-medium text-xs ml-1">PRO</span></span>
                      <span className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Face Mask Detection AI</span>
                    </div>
                  </div>
                  
                  <div className="hidden md:flex gap-8 text-[11px] font-bold uppercase tracking-widest text-slate-400">
                    <span className="text-slate-900 border-b-2 border-slate-900 py-5 cursor-pointer">Overview</span>
                    <span onClick={() => setIsReportOpen(true)} className="hover:text-slate-600 cursor-pointer transition-colors py-5 border-b-2 border-transparent">Reports</span>
                  </div>
                </div>
                
                <div className="flex items-center gap-6 text-slate-500">
                  <div className="hidden lg:block text-right pr-6 border-r border-slate-200">
                    <div className="text-slate-900 font-bold text-xs">{currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    <div className="text-[10px] text-slate-400 uppercase font-bold tracking-tighter">System Active</div>
                  </div>
                  <button className="hover:text-slate-900 transition-colors"><Search /></button>
                  <button className="hover:text-slate-900 transition-colors relative">
                    <Bell />
                    {stats.withoutMask > 0 && <span className="absolute top-0 right-0 w-2 h-2 bg-red-500 border-2 border-white rounded-full"></span>}
                  </button>
                </div>
              </nav>

              <div className="max-w-[1600px] mx-auto p-8 grid grid-cols-1 xl:grid-cols-12 gap-8 print:hidden">
                <div className="xl:col-span-8 space-y-8">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-xl font-bold text-slate-800">Real-Time Detection System</h2>
                      <p className="text-sm text-slate-500">Detection running in OpenCV window with live statistics</p>
                    </div>
                    <button onClick={() => setIsReportOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold uppercase tracking-wider hover:bg-slate-800 transition-all shadow-sm">
                      <FileText /> Generate Report
                    </button>
                  </div>

                  <div className="relative bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl overflow-hidden shadow-2xl border-4 border-white p-12">
                    <div className="text-center">
                      <Camera className="w-20 h-20 mx-auto mb-6 text-slate-400" />
                      <h3 className="text-white text-3xl font-bold mb-3">Detection Active</h3>
                      <p className="text-slate-300 text-lg mb-8">OpenCV window shows live camera with detection boxes</p>
                      
                      <div className="flex items-center justify-center gap-3 bg-black/30 backdrop-blur-sm px-6 py-3 rounded-lg mb-8 inline-flex">
                        <div className="w-4 h-4 bg-green-500 rounded-full animate-pulse"></div>
                        <span className="text-white text-lg font-medium">System Active</span>
                      </div>
                      
                      <div className="grid grid-cols-2 gap-4 max-w-md mx-auto mb-6">
                        <div className="bg-green-900/30 border-2 border-green-500 rounded-lg p-4">
                          <div className="w-full h-20 border-4 border-green-500 rounded mb-2"></div>
                          <p className="text-green-400 font-bold text-sm">Green Box = Mask</p>
                        </div>
                        <div className="bg-red-900/30 border-2 border-red-500 rounded-lg p-4">
                          <div className="w-full h-20 border-4 border-red-500 rounded mb-2"></div>
                          <p className="text-red-400 font-bold text-sm">Red Box = No Mask</p>
                        </div>
                      </div>
                    </div>
                    
                    <div className="absolute inset-0 pointer-events-none p-6">
                      <div className="absolute top-8 left-8 space-y-2">
                        <div className="flex items-center gap-2 bg-black/40 backdrop-blur-sm px-3 py-1.5 rounded-md border border-white/10">
                          <Activity />
                          <span className="text-white text-[10px] font-bold uppercase tracking-widest">{stats.total > 0 ? 'Active Detection' : 'Standby Mode'}</span>
                        </div>
                        <div className="flex items-center gap-2 bg-black/40 backdrop-blur-sm px-3 py-1.5 rounded-md border border-white/10">
                          <Camera />
                          <span className="text-white text-[10px] font-bold uppercase tracking-widest">Compliance: {stats.compliance.toFixed(1)}%</span>
                        </div>
                      </div>
                      
                      <div className="absolute bottom-8 left-8 right-8">
                        <div className="bg-black/40 backdrop-blur-sm px-4 py-3 rounded-md border border-white/10">
                          <div className="flex justify-between items-center text-white text-xs">
                            <span className="font-bold">Total: {stats.total}</span>
                            <span className="text-green-400">✓ Masked: {stats.withMask}</span>
                            <span className="text-red-400">✗ Unmasked: {stats.withoutMask}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white border border-slate-200 rounded-2xl p-6">
                    <h3 className="font-bold text-slate-800 text-sm flex items-center gap-2 uppercase tracking-widest mb-6">
                      <TrendingUp /> Hourly Compliance Trend
                    </h3>
                    <div className="h-24 flex items-end justify-between gap-1.5">
                      {hourlyData.length > 0 ? hourlyData.slice(-12).map((item, i) => {
                        const total = (item.With_Mask || 0) + (item.Without_Mask || 0);
                        const compliance = total > 0 ? ((item.With_Mask || 0) / total) * 100 : 0;
                        return (<div key={i} className="flex-1 bg-slate-100 rounded-t-sm group relative"><div style={{ height: `${compliance}%` }} className="bg-slate-300 group-hover:bg-slate-900 transition-all duration-300 w-full" /></div>);
                      }) : [40, 60, 45, 70, 90, 80, 55, 65, 85, 95, 100, 90].map((h, i) => (<div key={i} className="flex-1 bg-slate-100 rounded-t-sm group relative"><div style={{ height: `${h}%` }} className="bg-slate-300 group-hover:bg-slate-900 transition-all duration-300 w-full" /></div>))}
                    </div>
                  </div>
                </div>

                <div className="xl:col-span-4 space-y-6">
                  <div className="grid grid-cols-2 gap-4">
                    <StatCard icon={Users} label="Total Detected" value={stats.total} subtext="TODAY" />
                    <StatCard icon={Activity} label="Compliance" value={`${stats.compliance.toFixed(1)}%`} subtext="CURRENT" />
                    <StatCard icon={ShieldCheck} label="Masked" value={stats.withMask} subtext="PASSED" />
                    <StatCard icon={ShieldAlert} label="Alerts" value={stats.withoutMask} subtext="VIOLATIONS" status="error" />
                  </div>

                  <div className="bg-white border border-slate-200 rounded-2xl overflow-hidden">
                    <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                      <h3 className="font-bold text-slate-800 text-xs uppercase tracking-[0.2em] flex items-center gap-2"><Clock /> System Status</h3>
                    </div>
                    <div className="divide-y divide-slate-100">
                      <div className="p-4 flex gap-4">
                        <span className="text-[10px] font-bold text-slate-400 w-16">{currentTime.toLocaleTimeString()}</span>
                        <p className="text-xs font-medium text-green-600">{stats.total > 0 ? 'Detection system active' : 'System ready'}</p>
                      </div>
                      {stats.withoutMask > 0 && (<div className="p-4 flex gap-4"><span className="text-[10px] font-bold text-slate-400 w-16">Alert</span><p className="text-xs font-medium text-red-600">{stats.withoutMask} unmasked detection(s)</p></div>)}
                      <div className="p-4 flex gap-4"><span className="text-[10px] font-bold text-slate-400 w-16">Model</span><p className="text-xs font-medium text-slate-600">MobileNetV2 - 99%+ accuracy</p></div>
                    </div>
                  </div>
                </div>
              </div>

              {isReportOpen && (
                <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 md:p-8">
                  <div className="bg-white w-full max-w-4xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                    <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                      <div className="flex items-center gap-3"><FileText /><h2 className="text-xl font-bold">Compliance Report</h2></div>
                      <div className="flex items-center gap-3">
                        <button onClick={handleDownloadPDF} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 transition-all"><FileText /> Download PDF</button>
                        <button onClick={handlePrint} className="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-lg text-sm font-bold hover:bg-slate-800 transition-all"><Printer /> Print</button>
                        <button onClick={() => setIsReportOpen(false)} className="p-2 text-slate-400 hover:text-slate-900 transition-colors"><X /></button>
                      </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-12 bg-white">
                      <div className="border-b-2 border-slate-900 pb-8 mb-8 flex justify-between items-end">
                        <div>
                          <h1 className="text-3xl font-black text-slate-900 mb-2 uppercase tracking-tighter">Face Mask Compliance Report</h1>
                          <p className="text-slate-500 font-medium">P.S.R Engineering College - AI Detection System</p>
                        </div>
                        <div className="text-right">
                          <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Generated</p>
                          <p className="text-lg font-bold text-slate-900">{currentTime.toLocaleDateString()} {currentTime.toLocaleTimeString()}</p>
                        </div>
                      </div>

                      <div className="grid grid-cols-3 gap-8 mb-12">
                        <div className="p-6 bg-slate-50 rounded-xl border border-slate-100"><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Total Detections</p><p className="text-3xl font-black text-slate-900">{stats.total}</p></div>
                        <div className="p-6 bg-green-50 rounded-xl border border-green-100"><p className="text-[10px] font-bold text-green-600 uppercase tracking-widest mb-2">Compliance Rate</p><p className="text-3xl font-black text-green-700">{stats.compliance.toFixed(1)}%</p></div>
                        <div className="p-6 bg-red-50 rounded-xl border border-red-100"><p className="text-[10px] font-bold text-red-400 uppercase tracking-widest mb-2">Violations</p><p className="text-3xl font-black text-red-600">{stats.withoutMask}</p></div>
                      </div>

                      <div className="mb-12">
                        <h3 className="text-sm font-bold text-slate-900 uppercase tracking-[0.2em] mb-6 flex items-center gap-2"><TrendingUp /> Distribution Chart</h3>
                        <div className="bg-slate-50 p-8 rounded-2xl border border-slate-100">
                          <div className="flex items-center gap-6 mb-4"><div className="w-24 text-[10px] font-bold uppercase text-slate-400">Masked</div><div className="flex-1 bg-white h-8 rounded-lg border border-slate-200 overflow-hidden shadow-inner"><div className="bg-green-600 h-full transition-all duration-1000" style={{ width: `${stats.compliance}%` }}></div></div><div className="text-xs font-black text-slate-900">{stats.compliance.toFixed(1)}%</div></div>
                          <div className="flex items-center gap-6"><div className="w-24 text-[10px] font-bold uppercase text-slate-400">Unmasked</div><div className="flex-1 bg-white h-8 rounded-lg border border-slate-200 overflow-hidden shadow-inner"><div className="bg-red-500 h-full transition-all duration-1000" style={{ width: `${100 - stats.compliance}%` }}></div></div><div className="text-xs font-black text-slate-900">{(100 - stats.compliance).toFixed(1)}%</div></div>
                        </div>
                      </div>

                      <div className="pt-8 border-t border-slate-100 text-center">
                        <p className="text-xs text-slate-500 mb-2">Developed by Team PSR - P.S.R Engineering College, Sivakasi</p>
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">Mentor: Dr. Mohan B | Bharat AI-SoC Challenge 2026</p>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              <footer className="text-center py-12 px-8 print:hidden">
                <div className="inline-flex items-center gap-4 bg-white px-6 py-3 rounded-full border border-slate-200 shadow-sm">
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">P.S.R Engineering College Team</p>
                  <div className="w-[1px] h-4 bg-slate-200"></div>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Mentor: Dr. Mohan B</p>
                </div>
              </footer>
            </div>
          );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    {% endraw %}
</body>
</html>
